<html layout:decorate="~{layout}">
<head>
    <meta name="csrf-token" th:content="${_csrf.token}" />
</head>
<div layout:fragment="content" class="container my-3">
<form th:object="${postForm}" method="post" enctype="multipart/form-data">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <th:block th:if="${category=='recruitment'}">
   <div th:replace="~{recruitment_form :: recruitmentFragment}">
   </div>
    </th:block>
    <th:block th:if="${category=='band'}">
        <input type="hidden" th:name="bandId" th:value="${bandId}" />
    </th:block>
    <div th:if="${category=='band'}" class="mb-3">
        <label for="isPrivate" class="form-label">ê³µê°œ ì„¤ì •</label>
        <div>
          <input type="checkbox" th:field="*{isPrivate}" class="form-check-input">
          <span class="form-label mx-1">ë©¤ë²„ì—ê²Œë§Œ ê³µê°œ</span>
        </div>
      </div>
  <div class="mb-3">
    <label for="subject" class="form-label">ì œëª©</label>
    <input type="text" th:field="*{subject}" class="form-control" required />
  </div>
    <div class="mb-3">
  <label for="content" class="form-label">ë‚´ìš©</label>
  <textarea th:field="*{content}" rows="10" class="form-control" required></textarea>
    </div>
    <!-- ê¸°ì¡´ ì—…ë¡œë“œëœ ë¯¸ë””ì–´(ìˆ˜ì •í•  ë•Œ) -->
    <th:block th:if="${modify!=null and post.mediaList != null and !post.mediaList.isEmpty()}">
    <div id="existingMediaContainer" class="d-flex flex-wrap gap-3 mb-3">
        <th:block th:each="media : ${post.mediaList}">
            <div class="position-relative media-item" th:attr="data-size=${media.fileSize}">
                <th:block th:if="${media.mediaType.name() == 'IMAGE'}">
                    <img th:src="@{${media.filePath}}" class="rounded border" style="width: 120px; height: 120px;">
                </th:block>
                <th:block th:if="${media.mediaType.name() == 'VIDEO'}">
                    <video th:src="@{${media.filePath}}" controls class="rounded border" style="width: 200px;"></video>
                </th:block>
                <button th:attr="data-id=${media.id}" type="button" style="font-size: 13px;" class="btn-close position-absolute top-0 end-0 delete-media-btn"></button>
            </div>
        </th:block>
    </div>
    </th:block>

    <div class="mb-3">
   <div id="previewContainer" class="mt-3 d-flex flex-wrap gap-3"></div>
        <label for="mediaInput" class="form-label fw-semibold">ğŸ“ ë©€í‹°ë¯¸ë””ì–´(ì‚¬ì§„, ë™ì˜ìƒ) ì—…ë¡œë“œ</label>
        <input id="mediaInput" th:field="*{mediaList}" type="file" multiple
               class="form-control border-primary shadow-sm"
               accept="image/*,video/*"
               style="cursor: pointer;" />
        <small class="form-text text-muted">ì´ë¯¸ì§€ ë˜ëŠ” ë™ì˜ìƒì„ ì—¬ëŸ¬ ê°œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.</small>
    </div>
    <button type="submit" th:text="ì‘ì„±" class="btn btn-primary"></button>
  </form>
    <script>
       const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
       let existingMediaSize = 0;

       let existingMediaCount = document.querySelectorAll('#existingMediaContainer .media-item').length;
       document.querySelectorAll('#existingMediaContainer .media-item').forEach(item => {
       const size = parseInt(item.getAttribute('data-size'), 10);
       if (!isNaN(size)) {
        existingMediaSize += size;
            }
       });

       document.querySelectorAll('.delete-media-btn').forEach(button => {
           button.addEventListener('click', function () {
           const mediaId = this.getAttribute('data-id');
           const container = this.closest('.media-item');
           const size = parseInt(container.getAttribute('data-size'), 10);

           fetch(`/media/delete/${mediaId}`, {
               method: 'DELETE',
               headers: {
                   'X-CSRF-TOKEN': csrfToken,
                   'Content-Type': 'application/json'
               }
           })
           .then(response => {
               if (response.ok) {
                   const container = this.closest('.media-item');
                   container.remove();

                if (!isNaN(size)) {
                    existingMediaSize -= size;
                }
                existingMediaCount -= 1;
               }
           })
           .catch(() => {
               alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
           });
       });
   });

       const input = document.getElementById('mediaInput');
       const preview = document.getElementById('existingMediaContainer') || document.getElementById('previewContainer');

       const MAX_FILES = 10;
       const MAX_SIZE_MB = 40;

       let allFiles = [];

       input.addEventListener('change', function () {
        const files = Array.from(this.files);
        const tmpFiles = [...allFiles, ...files];
        const totalFiles = existingMediaCount + tmpFiles.length;

          if (totalFiles > MAX_FILES) {
              alert(`ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
              const dt = new DataTransfer();
              allFiles.forEach(file => dt.items.add(file));
              input.files = dt.files;
              return;
          }

          const addedSize = tmpFiles.reduce((acc, f) => acc + f.size, 0);
          const totalSize = existingMediaSize + addedSize;

          if (totalSize > MAX_SIZE_MB * 1024 * 1024) {
             alert(`ì „ì²´ íŒŒì¼ ìš©ëŸ‰ì´ ${MAX_SIZE_MB}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
             const dt = new DataTransfer();
             allFiles.forEach(file => dt.items.add(file));
             input.files = dt.files;
             return;
          }

        // ëˆ„ì  ë°°ì—´ì— ìƒˆ íŒŒì¼ ì¶”ê°€
        allFiles = tmpFiles;

        // FileListëŠ” ì§ì ‘ ìˆ˜ì • ë¶ˆê°€ëŠ¥ -> DataTransferë¡œ ìƒˆë¡œ ì„¸íŒ…
        const dataTransfer = new DataTransfer();
        allFiles.forEach(file => dataTransfer.items.add(file));
        input.files = dataTransfer.files;

         // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
         files.forEach(file => {
           const reader = new FileReader();

           reader.onload = function (e) {
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'position-relative media-item';

             let element;
             if (file.type.startsWith('image/')) {
               element = document.createElement('img');
               element.src = e.target.result;
               element.className = 'rounded border';
               element.style.width = '120px';
               element.style.height = '120px';
             } else if (file.type.startsWith('video/')) {
               element = document.createElement('video');
               element.src = e.target.result;
               element.controls = true;
               element.className = 'rounded border';
               element.style.width = '200px';
             }

             const deleteBtn = document.createElement('button');
             deleteBtn.type = 'button';
             deleteBtn.className = 'btn-close position-absolute top-0 end-0';
             deleteBtn.style.fontSize = '13px';

             deleteBtn.addEventListener('click', function () {
        // DOMì—ì„œ ì‚­ì œ
        wrapperDiv.remove();

        // allFilesì—ì„œ ì œê±°
        allFiles = allFiles.filter(f => f !== file);

        // input.files ì—…ë°ì´íŠ¸
        const dt = new DataTransfer();
        allFiles.forEach(f => dt.items.add(f));
        input.files = dt.files;
    });

            wrapperDiv.appendChild(element);
            wrapperDiv.appendChild(deleteBtn);
            preview.appendChild(wrapperDiv);
           };

           reader.readAsDataURL(file);
         });
       });
    </script>
</div>
</html>